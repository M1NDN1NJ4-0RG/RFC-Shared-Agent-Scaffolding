# Workflow: Lint and Format Check
#
# Purpose: Runs linting and formatting checks for all languages in the repository.
# Only runs checks for languages that have files present in the repository.
#
# Jobs:
# 1. lint-python: Runs Black, Flake8, and Pylint on Python files
# 2. lint-bash: Runs ShellCheck and shfmt on shell scripts
# 3. lint-powershell: Runs PSScriptAnalyzer on PowerShell scripts
# 4. lint-perl: Runs Perl::Critic on Perl files
#
# Triggers:
# - Pushes to main branch
# - Pull requests to main branch
#
# Dependencies:
# - Language-specific linters and formatters (installed in each job)
#
# Outputs:
# - Status checks for each language
# - Fails if any linting/formatting issues are found
#
# Notes:
# - Each language runs as a separate job for parallel execution
# - Jobs only run if relevant files exist in the repository
---
name: Lint and Format Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write  # Allow auto-commit for formatting fixes (only for lint-python job)
  pull-requests: read

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0  # Fetch full history for proper git operations

      - name: Check for Python files
        id: check-python
        run: |
          if [ -n "$(git ls-files '**/*.py')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_files == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python linters/formatters
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint

      - name: Run black (check mode)
        id: black-check
        if: steps.check-python.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          black --check --diff .

      - name: Auto-format with black (only for same-repo PRs)
        if: |
          steps.check-python.outputs.has_files == 'true' &&
          steps.black-check.outcome == 'failure' &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          github.actor != 'github-actions[bot]'
        run: |
          black .
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          if git diff --cached --quiet; then
            echo "No formatting changes to commit"
          else
            git commit -m "Auto-format Python code with Black [autoformat][skip ci]"
            git push
          fi

      - name: Create formatting patch artifact (for fork PRs)
        if: |
          steps.check-python.outputs.has_files == 'true' &&
          steps.black-check.outcome == 'failure' &&
          github.event.pull_request.head.repo.full_name != github.repository
        run: |
          black .
          git diff > black-formatting.patch
          echo "::error::Black formatting check failed. Since this is a fork PR, we cannot auto-commit. Please download the patch artifact and apply it to your branch."

      - name: Upload formatting patch
        if: |
          steps.check-python.outputs.has_files == 'true' &&
          steps.black-check.outcome == 'failure' &&
          github.event.pull_request.head.repo.full_name != github.repository
        uses: actions/upload-artifact@v4
        with:
          name: black-formatting-patch
          path: black-formatting.patch

      - name: Fail if black formatting needed and not fixed
        if: |
          steps.check-python.outputs.has_files == 'true' &&
          steps.black-check.outcome == 'failure' &&
          (github.event.pull_request.head.repo.full_name != github.repository || github.actor == 'github-actions[bot]')
        run: |
          echo "Black formatting check failed. See above for details."
          exit 1

      - name: Run flake8
        if: steps.check-python.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          flake8 .

      - name: Run pylint
        if: steps.check-python.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.py' | xargs -0 -r pylint

  lint-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Bash files
        id: check-bash
        run: |
          if [ -n "$(git ls-files '**/*.sh')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Set up Go for shfmt
        if: steps.check-bash.outputs.has_files == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: false

      - name: Install shfmt
        if: steps.check-bash.outputs.has_files == 'true'
        run: go install mvdan.cc/sh/v3/cmd/shfmt@v3.12.0

      - name: Run ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.sh' | xargs -0 -r shellcheck -S warning

      - name: Run shfmt (check)
        if: steps.check-bash.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.sh' | xargs -0 -r shfmt -d -i 2 -ci

  lint-powershell:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for PowerShell files
        id: check-powershell
        run: |
          if [ -n "$(git ls-files '**/*.ps1')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        continue-on-error: true
        shell: pwsh
        run: |
          $files = @(git ls-files '**/*.ps1')
          if ($files.Count -gt 0) {
            foreach ($file in $files) {
              Write-Host "Analyzing $file"
              Invoke-ScriptAnalyzer -Path $file -Severity Error -EnableExit
            }
          }

  lint-perl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Perl files
        id: check-perl
        run: |
          if [ -n "$(git ls-files '**/*.pl' '**/*.pm')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install cpanminus
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y cpanminus

      - name: Install Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          sudo cpanm --notest Perl::Critic

      - name: Run Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.pl' '**/*.pm' | xargs -0 -r perlcritic --severity 5

