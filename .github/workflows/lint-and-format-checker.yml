# Workflow: Lint and Format Check
#
# Purpose: Runs linting and formatting checks for all languages in the repository.
# Only runs checks for languages that have files present in the repository.
#
# Jobs:
# 1. lint-python: Runs Black, Flake8, and Pylint on Python files
# 2. lint-bash: Runs ShellCheck and shfmt on shell scripts
# 3. lint-powershell: Runs PSScriptAnalyzer on PowerShell scripts
# 4. lint-perl: Runs Perl::Critic on Perl files
# 5. lint-rust: Runs rustfmt and clippy on Rust code
#
# Triggers:
# - Pushes to main branch
# - Pull requests to main branch
#
# Dependencies:
# - Language-specific linters and formatters (installed in each job)
#
# Outputs:
# - Status checks for each language
# - Fails if any linting/formatting issues are found
#
# Notes:
# - Each language runs as a separate job for parallel execution
# - Jobs only run if relevant files exist in the repository
name: Lint and Format Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Python files
        id: check-python
        run: |
          if [ -n "$(git ls-files '*.py')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_files == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Python linters/formatters
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint

      - name: Run black (check mode)
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          black --check .

      - name: Run flake8
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          flake8 .

      - name: Run pylint
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          pylint $(git ls-files '*.py')

  lint-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Bash files
        id: check-bash
        run: |
          if [ -n "$(git ls-files '*.sh')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install shfmt
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          wget -O /tmp/shfmt https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Run ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          shellcheck $(git ls-files '*.sh')

      - name: Run shfmt (check)
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          shfmt -d -i 2 -ci $(git ls-files '*.sh')

  lint-powershell:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for PowerShell files
        id: check-powershell
        run: |
          if [ -n "$(git ls-files '*.ps1')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        shell: pwsh
        run: |
          $files = Get-ChildItem -Recurse -Filter '*.ps1' | Select-Object -ExpandProperty FullName
          if ($files) {
            Invoke-ScriptAnalyzer -Path $files -EnableExit
          }

  lint-perl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Perl files
        id: check-perl
        run: |
          if [ -n "$(git ls-files '*.pl' '*.pm')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          sudo cpanm --notest Perl::Critic

      - name: Run Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          perlcritic --severity 5 $(git ls-files '*.pl' '*.pm')

  lint-rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Rust files
        id: check-rust
        run: |
          if [ -f "rust/Cargo.toml" ] || [ -n "$(git ls-files '*.rs')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Rust toolchain
        if: steps.check-rust.outputs.has_files == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Run rustfmt (check)
        if: steps.check-rust.outputs.has_files == 'true'
        working-directory: rust
        run: |
          cargo fmt --all -- --check

      - name: Run clippy
        if: steps.check-rust.outputs.has_files == 'true'
        working-directory: rust
        run: |
          cargo clippy --all-targets --all-features -- -D warnings

