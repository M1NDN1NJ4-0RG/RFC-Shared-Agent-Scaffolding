# Workflow: Lint and Format Check
#
# Purpose: Runs linting and formatting checks for all languages in the repository.
# Only runs checks for languages that have files present in the repository.
#
# Jobs:
# 1. lint-python: Runs Black, Flake8, and Pylint on Python files
# 2. lint-bash: Runs ShellCheck and shfmt on shell scripts
# 3. lint-powershell: Runs PSScriptAnalyzer on PowerShell scripts
# 4. lint-perl: Runs Perl::Critic on Perl files
#
# Triggers:
# - Pushes to main branch
# - Pull requests to main branch
#
# Dependencies:
# - Language-specific linters and formatters (installed in each job)
#
# Outputs:
# - Status checks for each language
# - Fails if any linting/formatting issues are found
#
# Notes:
# - Each language runs as a separate job for parallel execution
# - Jobs only run if relevant files exist in the repository
name: Lint and Format Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Python files
        id: check-python
        run: |
          if [ -n "$(git ls-files '**/*.py')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-python.outputs.has_files == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python linters/formatters
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint

      - name: Run black (check mode)
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          black --check .

      - name: Run flake8
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          flake8 .

      - name: Run pylint
        if: steps.check-python.outputs.has_files == 'true'
        run: |
          git ls-files -z '**/*.py' | xargs -0 pylint

  lint-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Bash files
        id: check-bash
        run: |
          if [ -n "$(git ls-files '**/*.sh')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install shfmt
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          set -e
          SHFMT_VERSION=3.12.0
          SHFMT_CHECKSUM=d9fbb2a9c33d13f47e7618cf362a914d029d02a6df124064fff04fd688a745ea
          wget -O /tmp/shfmt https://github.com/mvdan/sh/releases/download/v${SHFMT_VERSION}/shfmt_v${SHFMT_VERSION}_linux_amd64
          echo "${SHFMT_CHECKSUM}  /tmp/shfmt" | sha256sum -c -
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Run ShellCheck
        if: steps.check-bash.outputs.has_files == 'true'
        run: |
          git ls-files -z '**/*.sh' | xargs -0 shellcheck -S warning

      - name: Run shfmt (check)
        if: steps.check-bash.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.sh' | xargs -0 shfmt -d -i 2 -ci

  lint-powershell:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for PowerShell files
        id: check-powershell
        run: |
          if [ -n "$(git ls-files '**/*.ps1')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        if: steps.check-powershell.outputs.has_files == 'true'
        shell: pwsh
        run: |
          $files = @(git ls-files '**/*.ps1' | Where-Object { $_ })
          if ($files.Count -gt 0) {
            foreach ($file in $files) {
              Write-Host "Analyzing $file"
              Invoke-ScriptAnalyzer -Path $file -Severity Error -EnableExit
            }
          }

  lint-perl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Perl files
        id: check-perl
        run: |
          if [ -n "$(git ls-files '**/*.pl' '**/*.pm')" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Install cpanminus
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y cpanminus

      - name: Install Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        run: |
          sudo cpanm --notest Perl::Critic

      - name: Run Perl::Critic
        if: steps.check-perl.outputs.has_files == 'true'
        continue-on-error: true
        run: |
          git ls-files -z '**/*.pl' '**/*.pm' | xargs -0 perlcritic --severity 5


