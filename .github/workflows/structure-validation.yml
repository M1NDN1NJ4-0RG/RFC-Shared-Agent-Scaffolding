# Workflow: Structure Validation
#
# Purpose: Validates that all language bundles follow the canonical directory
# structure defined in the RFC and checks for obsolete repository path references.
# Ensures each language bundle contains the required directories and files:
# - scripts/       (implementation files)
# - tests/         (test files)
# - run-tests.*    (test runner script)
# - README.md (optional documentation)
#
# Also verifies that obsolete paths from repository restructure have been
# properly migrated (e.g., 'documents/' -> 'docs/',
# 'RFC-Shared-Agent-Scaffolding-Example/' -> 'wrappers/')
#
# Triggers:
# - Pull requests modifying language bundles, validation scripts, or this workflow
# - Pushes to main branch affecting the same paths
# - Manual workflow dispatch
#
# Dependencies:
# - Bash (validate-structure.sh and verify-repo-references.sh scripts)
# - git ls-files
# - ripgrep (rg) for fast reference verification
#
# Outputs:
# - Status check: "Structure Validation"
# - Artifacts: None
# - Side effects: Fails if structure is incomplete
#
# Notes:
# - Required for merge
# - Exit 0 = structure valid, non-zero = violations detected
---
name: Structure Validation

on:
  pull_request:
    paths:
      - 'wrappers/scripts/**'
      - 'scripts/validate-structure.sh'
      - 'scripts/verify-repo-references.sh'
      - '.github/workflows/structure-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'wrappers/scripts/**'
      - 'scripts/validate-structure.sh'
      - 'scripts/verify-repo-references.sh'
      - '.github/workflows/structure-validation.yml'
  workflow_dispatch:

# Permissions: Read-only access to repository contents
permissions:
  contents: read

jobs:
  # Job: Validate Canonical Directory Structure
  # Runs scripts/validate-structure.sh to check all language bundles
  validate-structure:
    name: Validate Canonical Directory Structure
    # Runner: Ubuntu latest (provides bash for validation script)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository to access language bundles and validation script
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install ripgrep for improved reference verification performance
      # Ripgrep (rg) is faster and more efficient than grep for repository-wide searches
      - name: Install ripgrep
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ripgrep
          rg --version

      # Step 3: Run structure validation script
      # Makes script executable and executes it; script exits non-zero on validation failure
      - name: Run structure validation
        run: |
          chmod +x scripts/validate-structure.sh
          ./scripts/validate-structure.sh

      # Step 4: Verify repository references (obsolete path detection)
      # Runs verify-repo-references.sh in non-strict mode to report findings
      # This helps track migration progress for obsolete paths like 'documents/'
      # and 'RFC-Shared-Agent-Scaffolding-Example/' after repository restructure
      - name: Verify repository references
        run: |
          chmod +x scripts/verify-repo-references.sh
          ./scripts/verify-repo-references.sh

      # Step 5: Report success with expected structure documentation
      # Only runs if validation script succeeds (exit 0)
      - name: Report success
        if: success()
        run: |
          echo "✅ All language bundles follow the canonical directory structure"
          echo ""
          echo "Expected structure for each language:"
          echo "  scripts/<language>/"
          echo "    ├── scripts/          # Implementation files"
          echo "    ├── tests/            # Test files"
          echo "    ├── run-tests.*       # Test runner"
          echo "    └── README_TESTS.md   # Optional"
