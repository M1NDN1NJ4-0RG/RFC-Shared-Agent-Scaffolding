# Workflow: Repo Lint and Docstring Enforcement
#
# Purpose: Unified linting and docstring validation across all languages.
# Runs only the checks relevant to changed files, using repo_lint as the
# canonical enforcement mechanism.
#
# Jobs:
# 1. Auto-Fix: Black - Runs Black formatter in auto-fix mode (same-repo PRs only)
# 2. Detect Changed Files - Determines which language buckets have changes
# 3. Repo Lint: Python - Python linting + docstring validation
# 4. Repo Lint: Bash - Bash linting + docstring validation
# 5. Repo Lint: PowerShell - PowerShell linting + docstring validation
# 6. Repo Lint: Perl - Perl linting + docstring validation
# 7. Repo Lint: YAML - YAML linting
#
# Triggers:
# - Pushes to main branch
# - Pull requests to main branch
#
# Dependencies:
# - repo_lint Python package (tools/repo_lint/)
# - Language-specific linters (installed in each job)
#
# Outputs:
# - Status checks for each language with changes
# - Auto-fix commit (same-repo PRs) or patch artifact (fork PRs)
# - Forensic artifacts when Black makes changes
#
# Notes:
# - Auto-Fix job runs FIRST and skips all other jobs if changes are made
# - Conditional jobs run based on changed file detection
# - All third-party actions pinned by commit SHA
---
name: Repo Lint and Docstring Enforcement

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force all language jobs to run (ignores changed-file detection)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # Allow auto-commit for Black formatting (Auto-Fix job only)
  pull-requests: write  # Allow PR comments for Auto-Fix job

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Auto-Fix: Black
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # MANDATORY: Runs FIRST. If it changes files, all other jobs are skipped
  # to ensure subsequent checks run on the post-fix state.
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  auto-fix-black:
    name: "Auto-Fix: Black"
    runs-on: ubuntu-latest
    # Bot-loop guard: Skip if actor is a bot OR commit message contains autoformat marker
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, '[auto-format]')
    outputs:
      autofix_applied: ${{ steps.check_changes.outputs.changes_made }}
      run_url: ${{ steps.set_run_url.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          # Same-repo PRs: use PR head ref for commit capability
          # Fork PRs: use default ref (read-only)
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          fetch-depth: 0  # Full history for proper git operations
          # Same-repo PRs: use default token (write access)
          # Fork PRs: use default token (read-only, no push capability)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install Black
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install black==24.10.0

      - name: Run Black formatter
        id: black_run
        run: |
          echo "Running Black formatter..."
          black --line-length 120 --check --diff . > black_check.log 2>&1 || true
          black --line-length 120 . > black_fix.log 2>&1 || true
          echo "Black formatting complete."

      - name: Generate forensic artifacts
        id: generate_artifacts
        run: |
          # Create diff of changes
          git diff > black.diff

          # Create detailed log
          {
            echo "Black Auto-Fix Forensics"
            echo "========================"
            echo ""
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "Black Version: $(black --version)"
            echo ""
            echo "Files Modified:"
            git diff --name-only | sed 's/^/  - /'
            echo ""
            echo "Full Diff:"
            cat black.diff
          } > black.log

      - name: Check for changes
        id: check_changes
        run: |
          if [ -s black.diff ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Changes detected after Black formatting"
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No changes needed"
          fi

      - name: Upload forensic artifacts
        if: steps.check_changes.outputs.changes_made == 'true'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: black-autofix-forensics
          path: |
            black.diff
            black.log
          retention-days: 30

      - name: Set run URL output
        id: set_run_url
        run: |
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "url=$run_url" >> $GITHUB_OUTPUT

      - name: Write job summary
        if: steps.check_changes.outputs.changes_made == 'true'
        run: |
          {
            echo "## Black Auto-Fix Applied"
            echo ""
            echo "Black formatter made changes to the following files:"
            echo ""
            git diff --name-only | sed 's/^/- `/' | sed 's/$/`/'
            echo ""
            echo "### Forensic Artifacts"
            echo "- \`black.diff\`: Unified diff of all changes"
            echo "- \`black.log\`: Detailed log with timestamps and file list"
            echo ""
            echo "### Reproduce Locally"
            echo "\`\`\`bash"
            echo "black --line-length 120 ."
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY

      # Same-repo PR: commit and push changes with sync and retry
      - name: Commit and push changes (same-repo only)
        if: |
          steps.check_changes.outputs.changes_made == 'true' &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          github.event_name == 'pull_request'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Retry loop: attempt up to 3 times to sync, format, commit, and push
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = "false" ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS to commit and push auto-format changes..."

            # Stash any uncommitted changes (from Black formatting)
            echo "Stashing uncommitted changes..."
            git stash push -u -m "Auto-format changes from Black"

            # Sync with remote branch
            echo "Fetching latest changes from remote..."
            git fetch origin "${{ github.event.pull_request.head.ref }}"

            # Ensure we're on the correct branch
            git checkout "${{ github.event.pull_request.head.ref }}" || true

            # Rebase on top of the latest remote changes
            echo "Rebasing on latest remote changes..."
            if git rebase "origin/${{ github.event.pull_request.head.ref }}"; then
              echo "Rebase successful"
            else
              echo "Rebase had conflicts, aborting and retrying..."
              git rebase --abort
              git stash pop || true
              ATTEMPT=$((ATTEMPT + 1))
              sleep 2
              continue
            fi

            # Pop stashed changes
            echo "Applying stashed changes..."
            if ! git stash pop; then
              echo "Stash pop had conflicts, resolving by keeping formatted changes..."
              # Keep the stashed changes (formatted version)
              git checkout --ours .
              git add -A
            fi

            # Re-run Black formatter in case new changes need formatting
            echo "Re-running Black formatter..."
            black --line-length 120 . > /dev/null 2>&1 || true

            # Check if there are still changes after rebase
            if git diff --quiet && git diff --cached --quiet; then
              echo "No changes to commit after sync (formatting already applied or no longer needed)"
              SUCCESS=true
              break
            fi

            # Stage all changes
            git add -A

            # Commit with auto-format marker
            git commit -m "Auto-format: Apply Black formatting [auto-format]" || {
              echo "Commit failed, no changes to commit"
              SUCCESS=true
              break
            }

            # Try to push
            echo "Pushing changes..."
            if git push origin "${{ github.event.pull_request.head.ref }}"; then
              echo "Push successful!"
              SUCCESS=true
            else
              echo "Push failed (non-fast-forward), will retry..."
              # Fetch latest and reset to clean state for retry
              git fetch origin "${{ github.event.pull_request.head.ref }}"
              git reset --hard "origin/${{ github.event.pull_request.head.ref }}"
              ATTEMPT=$((ATTEMPT + 1))
              sleep 2
            fi
          done

          if [ "$SUCCESS" = "false" ]; then
            echo "::error::Failed to push auto-format changes after $MAX_ATTEMPTS attempts"
            exit 1
          fi

      # Same-repo PR: leave PR comment
      - name: Comment on PR (same-repo only)
        if: |
          steps.check_changes.outputs.changes_made == 'true' &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const body = `## ðŸ”§ Black Auto-Fix Applied

            Black formatter has automatically formatted your code and pushed a commit.

            **Workflow Run:** ${{ steps.set_run_url.outputs.url }}

            **Forensic Artifacts:** Download the \`black-autofix-forensics\` artifact from \
            the workflow run to review the exact changes.

            **Next Steps:**
            - Pull the changes: \`git pull\`
            - Lint checks will run on the next workflow run for the updated commit.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # Fork PR: produce patch artifact and fail with instructions
      - name: Fail with patch instructions (fork PRs only)
        if: |
          steps.check_changes.outputs.changes_made == 'true' &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "âŒ Black formatting changes required, but cannot auto-commit to fork."
          echo ""
          echo "Please download the 'black-autofix-forensics' artifact and apply the patch:"
          echo "  1. Download black.diff from workflow artifacts"
          echo "  2. Apply patch: git apply black.diff"
          echo "  3. Commit and push: git commit -am 'Apply Black formatting' && git push"
          echo ""
          echo "Or run Black locally:"
          echo "  black --line-length 120 ."
          exit 1

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Detect Changed Files
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Determines which language buckets have changes and sets output flags.
  # Includes special "shared_tooling" flag for changes to lint infrastructure.
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  detect-changed-files:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    needs: auto-fix-black
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, '[auto-format]') &&
      needs.auto-fix-black.outputs.autofix_applied != 'true'
    outputs:
      python: ${{ steps.detect.outputs.python }}
      bash: ${{ steps.detect.outputs.bash }}
      powershell: ${{ steps.detect.outputs.powershell }}
      perl: ${{ steps.detect.outputs.perl }}
      yaml: ${{ steps.detect.outputs.yaml }}
      rust: ${{ steps.detect.outputs.rust }}
      shared_tooling: ${{ steps.detect.outputs.shared_tooling }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: detect
        run: |
          # Get base ref for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            # For push events, compare with previous commit; fall back to empty tree on initial commit
            BASE_REF=$(git rev-parse --verify HEAD^ 2>/dev/null || echo "4b825dc642cb6eb9a060e54bf8d69288fbee4904")
          fi

          # Get changed files
          CHANGED_FILES=$(git diff --name-only "$BASE_REF" HEAD)

          # Initialize all outputs to false
          echo "python=false" >> $GITHUB_OUTPUT
          echo "bash=false" >> $GITHUB_OUTPUT
          echo "powershell=false" >> $GITHUB_OUTPUT
          echo "perl=false" >> $GITHUB_OUTPUT
          echo "yaml=false" >> $GITHUB_OUTPUT
          echo "rust=false" >> $GITHUB_OUTPUT
          echo "shared_tooling=false" >> $GITHUB_OUTPUT

          # Check for Python files
          if echo "$CHANGED_FILES" | grep -qE '\.py$'; then
            echo "python=true" >> $GITHUB_OUTPUT
          fi

          # Check for Bash files
          if echo "$CHANGED_FILES" | grep -qE '\.(sh|bash|zsh)$'; then
            echo "bash=true" >> $GITHUB_OUTPUT
          fi

          # Check for PowerShell files
          if echo "$CHANGED_FILES" | grep -qE '\.ps1$'; then
            echo "powershell=true" >> $GITHUB_OUTPUT
          fi

          # Check for Perl files
          if echo "$CHANGED_FILES" | grep -qE '\.(pl|pm)$'; then
            echo "perl=true" >> $GITHUB_OUTPUT
          fi

          # Check for YAML files
          if echo "$CHANGED_FILES" | grep -qE '\.(ya?ml)$'; then
            echo "yaml=true" >> $GITHUB_OUTPUT
          fi

          # Check for Rust files
          if echo "$CHANGED_FILES" | grep -qE '\.rs$|^rust/|Cargo\.(toml|lock)$'; then
            echo "rust=true" >> $GITHUB_OUTPUT
          fi

          # Check for shared tooling changes
          if echo "$CHANGED_FILES" | grep -qE \
              '(^|/)tools/repo_lint/|scripts/validate_docstrings\.py|scripts/docstring_validators/' ||
             echo "$CHANGED_FILES" | grep -qE \
              '^pyproject\.toml$|^\.github/workflows/|docs/contributing/'; then
            echo "shared_tooling=true" >> $GITHUB_OUTPUT
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: Python
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-python:
    name: "Repo Lint: Python"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.python == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install Python linting tools
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install black==24.10.0 ruff==0.8.4 pylint==3.3.2 yamllint==1.35.1

      - name: Run repo_lint for Python
        id: lint_python
        run: |
          python3 -m tools.repo_lint check --ci --only python 2>&1 | tee python-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload Python lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: python-lint-results
          path: python-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: Bash
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-bash:
    name: "Repo Lint: Bash"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.bash == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install Python tools (for repo_lint)
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install tree-sitter==0.25.1 tree-sitter-bash==0.25.1

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          wget -qO /tmp/shfmt https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_linux_amd64
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Run repo_lint for Bash
        id: lint_bash
        run: |
          python3 -m tools.repo_lint check --ci --only bash 2>&1 | tee bash-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload Bash lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: bash-lint-results
          path: bash-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: PowerShell
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-powershell:
    name: "Repo Lint: PowerShell"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.powershell == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -RequiredVersion 1.23.0 -Force -Scope CurrentUser

      - name: Run repo_lint for PowerShell
        id: lint_powershell
        run: |
          python3 -m tools.repo_lint check --ci --only powershell 2>&1 | tee powershell-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload PowerShell lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: powershell-lint-results
          path: powershell-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: Perl
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-perl:
    name: "Repo Lint: Perl"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.perl == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Set up Perl
        uses: shogo82148/actions-setup-perl@9c1eca9952ccc07f9ca4a2097b63df93d9d138e9  # v1.31.3
        with:
          perl-version: "5.38"

      - name: Install Perl::Critic and PPI
        run: |
          cpanm --notest Perl::Critic PPI

      - name: Run repo_lint for Perl
        id: lint_perl
        run: |
          python3 -m tools.repo_lint check --ci --only perl 2>&1 | tee perl-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload Perl lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: perl-lint-results
          path: perl-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: YAML
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-yaml:
    name: "Repo Lint: YAML"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.yaml == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install yamllint==1.35.1

      - name: Run repo_lint for YAML
        id: lint_yaml
        run: |
          python3 -m tools.repo_lint check --ci --only yaml 2>&1 | tee yaml-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload YAML lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: yaml-lint-results
          path: yaml-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Repo Lint: Rust
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  repo-lint-rust:
    name: "Repo Lint: Rust"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      (needs.detect-changed-files.outputs.rust == 'true' ||
       needs.detect-changed-files.outputs.shared_tooling == 'true' ||
       inputs.force_all == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source "$HOME/.cargo/env"
          rustup component add rustfmt clippy

      - name: Cache Rust dependencies
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57  # v4.2.0
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run repo_lint for Rust
        id: lint_rust
        run: |
          source "$HOME/.cargo/env"
          python3 -m tools.repo_lint check --ci --only rust 2>&1 | tee rust-lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Upload Rust lint results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: rust-lint-results
          path: rust-lint-output.txt
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Vector Tests: Conformance
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Runs vector-based conformance tests to ensure deterministic linting
  # and docstring enforcement behavior across parser implementations.
  # Triggered when tooling or validator code changes.
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  vector-tests:
    name: "Vector Tests: Conformance"
    runs-on: ubuntu-latest
    needs: [auto-fix-black, detect-changed-files]
    if: |
      needs.auto-fix-black.outputs.autofix_applied != 'true' &&
      needs.detect-changed-files.outputs.shared_tooling == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install pytest
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pytest

      - name: Run vector tests
        run: |
          python3 -m pytest tools/repo_lint/tests/test_vectors.py -v

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Consolidate and Archive Logs
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Waits for all lint jobs to complete and consolidates ALL logs (success + failure)
  # into a summary artifact and commits logs to the repository for review.
  # Runs always to ensure comprehensive logging regardless of job outcomes.
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  consolidate-failures:
    name: "Consolidate and Archive Logs"
    runs-on: ubuntu-latest
    needs:
      - auto-fix-black
      - detect-changed-files
      - repo-lint-python
      - repo-lint-bash
      - repo-lint-powershell
      - repo-lint-perl
      - repo-lint-yaml
      - repo-lint-rust
      - vector-tests
    # Bot-loop guard: Skip if actor is a bot OR commit message contains auto-generated marker
    # Run even if previous jobs failed (always()) but not if triggered by bot
    if: |
      always() &&
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, '[auto-generated]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          # Use PR head ref for same-repo PRs to allow commit
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Python lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: python-lint-results
          path: lint-artifacts/python-lint-results/

      - name: Download Bash lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: bash-lint-results
          path: lint-artifacts/bash-lint-results/

      - name: Download PowerShell lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: powershell-lint-results
          path: lint-artifacts/powershell-lint-results/

      - name: Download Perl lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: perl-lint-results
          path: lint-artifacts/perl-lint-results/

      - name: Download YAML lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: yaml-lint-results
          path: lint-artifacts/yaml-lint-results/

      - name: Download Rust lint artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: rust-lint-results
          path: lint-artifacts/rust-lint-results/

      - name: Download Auto-Fix artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        continue-on-error: true
        with:
          name: black-autofix-forensics
          path: lint-artifacts/autofix-forensics/

      - name: "Debug: List downloaded artifacts"
        run: |
          echo "=== Listing lint-artifacts directory ==="
          ls -laR lint-artifacts/ || echo "No lint-artifacts directory found"
          echo "========================================="

      - name: Collect job results
        id: collect_results
        run: |
          # Create log directory with required path format
          # Format: /logs/umbrella-ci-logs-phase-6/RUN_ID/
          RUN_ID="${{ github.run_id }}"
          LOG_DIR="logs/umbrella-ci-logs-phase-6/${RUN_ID}"
          mkdir -p "$LOG_DIR"

          # Check job statuses (now using job.result since continue-on-error is removed)
          AUTO_FIX="${{ needs.auto-fix-black.result }}"
          DETECT="${{ needs.detect-changed-files.result }}"
          PYTHON="${{ needs.repo-lint-python.result }}"
          BASH="${{ needs.repo-lint-bash.result }}"
          POWERSHELL="${{ needs.repo-lint-powershell.result }}"
          PERL="${{ needs.repo-lint-perl.result }}"
          YAML="${{ needs.repo-lint-yaml.result }}"
          RUST="${{ needs.repo-lint-rust.result }}"
          VECTORS="${{ needs.vector-tests.result }}"

          # Map empty results (skipped jobs) to "skipped" for display
          PYTHON="${PYTHON:-skipped}"
          BASH="${BASH:-skipped}"
          POWERSHELL="${POWERSHELL:-skipped}"
          PERL="${PERL:-skipped}"
          YAML="${YAML:-skipped}"
          RUST="${RUST:-skipped}"
          VECTORS="${VECTORS:-skipped}"

          # Create summary file
          SUMMARY_FILE="${LOG_DIR}/summary.md"
          {
            echo "# Repo Lint Summary"
            echo ""
            echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "**Branch:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo ""
            echo "## Job Results"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Auto-Fix: Black | $AUTO_FIX |"
            echo "| Detect Changed Files | $DETECT |"
            echo "| Repo Lint: Python | $PYTHON |"
            echo "| Repo Lint: Bash | $BASH |"
            echo "| Repo Lint: PowerShell | $POWERSHELL |"
            echo "| Repo Lint: Perl | $PERL |"
            echo "| Repo Lint: YAML | $YAML |"
            echo "| Repo Lint: Rust | $RUST |"
            echo "| Vector Tests: Conformance | $VECTORS |"
            echo ""
          } > "$SUMMARY_FILE"

          # Track if any failures occurred
          HAS_FAILURES=false

          # Copy all job artifacts to log directory (regardless of pass/fail)
          # This ensures comprehensive logging on both success and failure

          # Auto-Fix artifacts (if they exist)
          AUTOFIX_DIFF="lint-artifacts/autofix-forensics/black.diff"
          AUTOFIX_LOG="lint-artifacts/autofix-forensics/black.log"
          if [ -f "$AUTOFIX_DIFF" ]; then
            cp "$AUTOFIX_DIFF" "${LOG_DIR}/black.diff"
            echo "Captured Black diff" >&2
          fi
          if [ -f "$AUTOFIX_LOG" ]; then
            cp "$AUTOFIX_LOG" "${LOG_DIR}/black.log"
            echo "Captured Black log" >&2
          fi

          # Python logs
          PYTHON_ARTIFACT="lint-artifacts/python-lint-results/python-lint-output.txt"
          if [ -f "$PYTHON_ARTIFACT" ]; then
            cp "$PYTHON_ARTIFACT" "${LOG_DIR}/python-lint-output.txt"
            echo "Captured Python lint output" >&2
          fi

          # Add failure details for each failed job
          if [ "$PYTHON" = "failure" ]; then
            HAS_FAILURES=true
            echo "## Python Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$PYTHON_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$PYTHON_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: Python lint artifact not found at: $PYTHON_ARTIFACT" >&2
              echo "Python linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          # Bash logs
          BASH_ARTIFACT="lint-artifacts/bash-lint-results/bash-lint-output.txt"
          if [ -f "$BASH_ARTIFACT" ]; then
            cp "$BASH_ARTIFACT" "${LOG_DIR}/bash-lint-output.txt"
            echo "Captured Bash lint output" >&2
          fi

          if [ "$BASH" = "failure" ]; then
            HAS_FAILURES=true
            echo "## Bash Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$BASH_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$BASH_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: Bash lint artifact not found at: $BASH_ARTIFACT" >&2
              echo "Bash linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          # PowerShell logs
          POWERSHELL_ARTIFACT="lint-artifacts/powershell-lint-results/powershell-lint-output.txt"
          if [ -f "$POWERSHELL_ARTIFACT" ]; then
            cp "$POWERSHELL_ARTIFACT" "${LOG_DIR}/powershell-lint-output.txt"
            echo "Captured PowerShell lint output" >&2
          fi

          if [ "$POWERSHELL" = "failure" ]; then
            HAS_FAILURES=true
            echo "## PowerShell Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$POWERSHELL_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$POWERSHELL_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: PowerShell lint artifact not found at: $POWERSHELL_ARTIFACT" >&2
              echo "PowerShell linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          # Perl logs
          PERL_ARTIFACT="lint-artifacts/perl-lint-results/perl-lint-output.txt"
          if [ -f "$PERL_ARTIFACT" ]; then
            cp "$PERL_ARTIFACT" "${LOG_DIR}/perl-lint-output.txt"
            echo "Captured Perl lint output" >&2
          fi

          if [ "$PERL" = "failure" ]; then
            HAS_FAILURES=true
            echo "## Perl Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$PERL_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$PERL_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: Perl lint artifact not found at: $PERL_ARTIFACT" >&2
              echo "Perl linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          # YAML logs
          YAML_ARTIFACT="lint-artifacts/yaml-lint-results/yaml-lint-output.txt"
          if [ -f "$YAML_ARTIFACT" ]; then
            cp "$YAML_ARTIFACT" "${LOG_DIR}/yaml-lint-output.txt"
            echo "Captured YAML lint output" >&2
          fi

          if [ "$YAML" = "failure" ]; then
            HAS_FAILURES=true
            echo "## YAML Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$YAML_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$YAML_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: YAML lint artifact not found at: $YAML_ARTIFACT" >&2
              echo "YAML linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          # Rust logs
          RUST_ARTIFACT="lint-artifacts/rust-lint-results/rust-lint-output.txt"
          if [ -f "$RUST_ARTIFACT" ]; then
            cp "$RUST_ARTIFACT" "${LOG_DIR}/rust-lint-output.txt"
            echo "Captured Rust lint output" >&2
          fi

          if [ "$RUST" = "failure" ]; then
            HAS_FAILURES=true
            echo "## Rust Linting Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            if [ -f "$RUST_ARTIFACT" ]; then
              echo '```' >> "$SUMMARY_FILE"
              tail -100 "$RUST_ARTIFACT" >> "$SUMMARY_FILE"
              echo '```' >> "$SUMMARY_FILE"
            else
              echo "WARNING: Rust lint artifact not found at: $RUST_ARTIFACT" >&2
              echo "Rust linting failed. See job logs for details." >> "$SUMMARY_FILE"
            fi
            echo "" >> "$SUMMARY_FILE"
          fi

          if [ "$VECTORS" = "failure" ]; then
            HAS_FAILURES=true
            echo "## Vector Test Failures" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "Vector tests failed. See job logs for details." >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
          fi

          # Set output flag and log directory path
          if [ "$HAS_FAILURES" = "true" ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "## All Checks Passed âœ“" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "All linting and docstring enforcement checks passed successfully." >> "$SUMMARY_FILE"
          fi

          # Export log directory for subsequent steps
          echo "log_dir=${LOG_DIR}" >> $GITHUB_OUTPUT

          # Display summary
          cat "$SUMMARY_FILE"

      - name: Upload log summary artifact (always)
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: umbrella-ci-logs
          path: logs/umbrella-ci-logs-phase-6/
          retention-days: 30

      - name: Commit logs to repository (always, same-repo PRs only)
        if: |
          always() &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          github.event_name == 'pull_request' &&
          github.actor != 'github-actions[bot]' &&
          !contains(github.event.head_commit.message, '[auto-generated]')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all logs (success and failure)
          git add logs/umbrella-ci-logs-phase-6/

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit (logs may already exist)"
          else
            git commit -m "CI: Add umbrella workflow logs [auto-generated]"

            # Push with error handling
            if ! git push; then
              echo "::warning::Failed to push logs to repository"
              exit 1
            fi
          fi

      - name: Add job summary
        if: always()
        run: |
          # Find the summary file in the log directory
          LOG_DIR="${{ steps.collect_results.outputs.log_dir }}"
          SUMMARY_FILE="${LOG_DIR}/summary.md"
          if [ -f "$SUMMARY_FILE" ]; then
            cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          else
            echo "::warning::No summary file found at ${SUMMARY_FILE}"
            echo "## Logs Collection Status" >> $GITHUB_STEP_SUMMARY
            echo "Log directory: ${LOG_DIR}" >> $GITHUB_STEP_SUMMARY
            echo "Summary file was not created." >> $GITHUB_STEP_SUMMARY
          fi
