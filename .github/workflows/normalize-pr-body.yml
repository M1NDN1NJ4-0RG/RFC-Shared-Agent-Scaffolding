name: normalize-pr-body

on:
  pull_request:
    types: [opened, edited, reopened, ready_for_review]

permissions:
  pull-requests: write

jobs:
  normalize:
    runs-on: ubuntu-latest
    steps:
      - name: Rewrite auto-close keywords in PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Replace only the keyword part; keep the rest intact.
            // Example: "Fixes #3" -> "Refs #3"
            const rewritten = body.replace(
              /(\b)(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)(\s+)([A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+)?#(\d+)\b/gi,
              (m, p1, kw, sp, repoPrefix, num) => `${p1}Refs${sp}${repoPrefix || ""}#${num}`
            );

            if (rewritten !== body) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: rewritten,
              });
              core.notice("PR body updated to remove auto-close keywords.");
            } else {
              core.notice("No auto-close keywords found in PR body.");
            }
