# Workflow: Test Bash Bundle
#
# Purpose: Runs conformance tests for the Bash implementation of safe-run wrapper.
# Validates that the Bash wrapper correctly delegates to the Rust canonical binary
# and follows M0 contract specifications.
#
# Dependencies:
# - Rust canonical binary (built and staged at dist/linux/x86_64/safe-run)
# - jq (for JSON conformance vector parsing)
# - Bash test suite (run-tests.sh)
#
# Triggers:
# - Pull requests modifying Bash bundle, conformance data, or this workflow
# - Pushes to main branch affecting the same paths
# - Manual workflow dispatch
#
# Outputs:
# - Status check: "Test Bash Bundle"
# - Artifacts: None (test logs printed to stdout)
# - Side effects: Fails if tests fail
#
# Notes:
# - Required for merge
# - Exit 0 = tests pass, non-zero = tests fail
---
name: Test Bash Bundle

on:
  pull_request:
    paths:
      - 'wrappers/bash/**'
      - 'conformance/**'
      - '.github/workflows/test-bash.yml'
  push:
    branches:
      - main
    paths:
      - 'wrappers/bash/**'
      - 'conformance/**'
      - '.github/workflows/test-bash.yml'
  workflow_dispatch:

# Permissions: Read-only access to repository contents
permissions:
  contents: read

jobs:
  # Job: Bash Bundle Tests
  # Builds Rust canonical tool, stages it for wrapper discovery, runs Bash tests
  test:
    name: Bash Bundle Tests
    # Runner: Ubuntu latest (provides bash, Rust toolchain)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository to access Bash bundle and Rust source
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Rust stable toolchain for building canonical binary
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      # Step 3: Build Rust canonical tool in release mode
      # This is the reference implementation that the Bash wrapper delegates to
      - name: Build Rust canonical tool
        run: |
          cd rust
          cargo build --release
          cd ..

      # Step 4: Stage Rust binary at standard discovery location
      # Bash wrapper uses SAFE_RUN_BIN environment variable to locate this binary
      # (set by run-tests.sh or test harness)
      - name: Stage Rust binary for wrapper discovery
        run: |
          mkdir -p dist/linux/x86_64
          cp rust/target/release/safe-run dist/linux/x86_64/safe-run
          chmod +x dist/linux/x86_64/safe-run
          echo "Rust binary staged at: dist/linux/x86_64/safe-run"
          ls -lh dist/linux/x86_64/safe-run

      # Step 5: Install jq for JSON parsing in Bash tests
      # Required by Bash wrapper to read conformance/vectors.json
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          jq --version

      # Step 6: Run Bash test suite
      # Executes run-tests.sh which runs all tests in tests/ directory
      # Test runner sets SAFE_RUN_BIN to point to staged Rust binary
      - name: Run Bash tests
        working-directory: wrappers/bash
        run: |
          chmod +x run-tests.sh
          ./run-tests.sh

      # Step 7: Upload failure logs as artifacts (only on test failure)
      # Preserves .agent/FAIL-LOGS/ directory for debugging
      # if-no-files-found: ignore prevents failure if no logs exist
      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bash-test-failures
          path: wrappers/bash/.agent/FAIL-LOGS/
          if-no-files-found: ignore
