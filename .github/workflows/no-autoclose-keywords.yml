name: no-autoclose-keywords

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  check:
    name: no-autoclose-keywords
    runs-on: ubuntu-latest

    steps:
      - name: Scan PR title/body and commits for auto-close keywords
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Match GitHub autoclose keywords (case-insensitive), with optional ":".
          # Examples: "Fixes #123", "fixes: owner/repo#123", "Closes #9"
          PATTERN='(^|[^[:alnum:]_])(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)([[:space:]]*:[[:space:]]*|[[:space:]]+)([[:alnum:]_.-]+\/[[:alnum:]_.-]+)?#([0-9]+)\b'

          fail() { echo "::error::$1"; exit 1; }

          # Some systems append an "Original prompt" blob that may contain forbidden text
          # and is not user-editable. Ignore everything from that heading down.
          sanitize_body() {
            awk '
              BEGIN { drop=0 }
              /Original prompt[[:space:]]*$/ { drop=1 }
              { if (!drop) print }
            '
          }

          title="$PR_TITLE"
          body="$(printf '%s' "$PR_BODY" | sanitize_body)"

          printf '%s' "$title" | grep -Eiq "$PATTERN" && fail "Auto-close keyword found in PR TITLE. Use Refs/Related/Tracks instead."
          printf '%s' "$body"  | grep -Eiq "$PATTERN" && fail "Auto-close keyword found in PR BODY (excluding 'Original prompt' block). Use Refs/Related/Tracks instead."

          # Scan commit messages (subject + body) for the PR via the pulls/{pull_number}/commits endpoint.
          # Use pagination to ensure we inspect all commits, not just the first 100.
          base_commits_api="https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUMBER/commits"

          page=1
          while :; do
            commits_api="${base_commits_api}?per_page=100&page=${page}"
            commits_json="$(curl -sSf \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$commits_api")"

            # Extract commit messages from this page.
            commit_messages="$(echo "$commits_json" | jq -r '.[].commit.message')"

            # If no messages were returned, we've reached the end of pagination.
            if [ -z "$commit_messages" ]; then
              break
            fi

            printf '%s\n' "$commit_messages" | grep -Eiq "$PATTERN" \
              && fail "Auto-close keyword found in a COMMIT message in this PR. Amend/reword commit(s) to use Refs/Related/Tracks."

            # If fewer than 100 commits were returned, this was the last page.
            page_count="$(echo "$commits_json" | jq 'length')"
            if [ "$page_count" -lt 100 ]; then
              break
            fi

            page=$((page + 1))
          done
          echo "OK: No auto-close keywords detected (title/body/commits)."
