# Workflow: Copilot Setup Steps
#
# Purpose:
#   Pre-install and verify common toolchains in the GitHub Actions runner environment so
#   Copilot Coding Agent sessions can run immediately (repo-lint, formatters, linters, etc.).
#   Provides a deterministic baseline for CI and agent workflows without requiring
#   per-session bootstrap scripts.
#
# Triggers:
#   - Manual workflow_dispatch (for validation)
#   - Push/PRs that modify this workflow file
#
# Dependencies:
#   - Base OS tools (always):
#     - ripgrep (rg) for searching (REQUIRED grep tool)
#     - jq for JSON inspection
#     - curl for downloading pinned binaries
#     - perl + cpanminus (cpanm) for Perl tooling
#     - archive/compression utilities:
#       - zip/unzip, 7zip (p7zip), zstd, xz-utils, pigz, bzip2, lz4, pbzip2
#     - file/tree helpers:
#       - file, tree
#     - optional media tooling (commented out by default):
#       - ffmpeg, mediainfo
#   - YAML tooling (always):
#     - yq (Mike Farah Go-yq) installed from GitHub releases (pinned version)
#   - Python tooling (always):
#     - Python 3.12 via actions/setup-python
#     - pip caching keyed by repo root `pyproject.toml`
#     - Python CLI/tooling installed via pip --user
#     - repo-lint installed from THIS repository (editable) via repo root `pyproject.toml`
#     - common agent libraries installed (non-exhaustive):
#       - formatting/lint/test: black, ruff, pylint, yamllint, pytest, mdformat
#       - CLI/UI: click, rich, rich-click, typer, tqdm
#       - networking: paramiko, netmiko, napalm, ntc-templates, textfsm
#       - JSON/YAML/TOML: json5, jsonschema, orjson, ruamel.yaml, toml, tomlkit, tomli-w
#       - HTTP/retry: requests, httpx, tenacity
#   - Shell toolchain (conditional):
#     - shellcheck (apt) only when *.sh exists
#     - shfmt (Go install) only when *.sh exists
#   - GitHub Actions linting (conditional):
#     - actionlint (Go install) only when workflow files exist
#   - PowerShell toolchain (conditional):
#     - pwsh presence verified (ubuntu-latest includes pwsh)
#     - PSScriptAnalyzer installed only when *.ps1 exists
#   - Perl toolchain (conditional):
#     - Perl::Critic + PPI via apt when *.pl exists (preferred)
#     - cpanm fallback when *.pl exists (best-effort)
#   - Rust toolchain (conditional, when rust/** exists):
#     - dtolnay/rust-toolchain@stable with rustfmt + clippy components
#     - helper tools via taiki-e/install-action (includes taplo)
#   - Markdown linting (conditional):
#     - Node.js 20 setup when *.md exists
#     - markdownlint-cli2 installed globally when *.md exists
#
# Outputs:
#   - Job name MUST be `copilot-setup-steps` for Copilot to pick it up
#   - All required tools verified and available in PATH
#   - repo-lint verified via `repo-lint --help`
#
# Notes:
#   - Go is only set up when shfmt and/or actionlint are required
#   - PATH updates via $GITHUB_PATH only apply to subsequent steps
#   - This workflow is intentionally verbose about tool verification to fail fast when a
#     runner environment is missing required capabilities
#   - The Python package set is intentionally broader than this repository's direct runtime
#     dependencies to give Copilot Coding Agent sessions a rich, ready-to-use environment

name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Python tooling (always installed)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: pyproject.toml

      - name: Install required OS packages
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update

          APT_TOOLS=(
            ripgrep
            jq
            curl
            perl
            cpanminus
            zip
            unzip
            p7zip-full
            zstd
            xz-utils
            pigz
            bzip2
            lz4
            pbzip2
            file
            tree
          )

          sudo apt-get install -y --no-install-recommends "${APT_TOOLS[@]}"

          # Install Mike Farah's Go-yq (the Ubuntu/Debian `yq` package is a different implementation)
          YQ_VERSION="v4.44.3"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64|amd64) YQ_ARCH="amd64" ;;
            aarch64|arm64) YQ_ARCH="arm64" ;;
            *)
              echo "ERROR: Unsupported architecture for yq: $ARCH" >&2
              exit 1
              ;;
          esac

          sudo curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_${YQ_ARCH}" -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

          # Optional media tooling (commented out by default to reduce install time/surface area)
          # Uncomment if/when the repo needs media processing helpers.
          # sudo apt-get install -y --no-install-recommends \
          #   ffmpeg \
          #   mediainfo
          #
          # ffmpeg -version
          # mediainfo --Version

          # Conditional tools (only installed if the repo contains relevant files)
          if git ls-files '*.sh' | rg -q .; then
            sudo apt-get install -y --no-install-recommends shellcheck
          fi

          if git ls-files '*.pl' | rg -q .; then
            # Prefer apt packages when available (faster + deterministic)
            sudo apt-get install -y --no-install-recommends \
              libperl-critic-perl \
              libppi-perl
          fi

          # PowerShell is preinstalled on ubuntu-latest runners, but verify it's present
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "ERROR: pwsh not found on runner" >&2
            exit 1
          fi

      - name: Install Python CLI tools (black, click, mdformat, network libs, pylint, pytest, repo-lint, rich, ruff, yamllint)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          # Ensure user-level scripts are available in THIS step as well
          export PATH="$HOME/.local/bin:$PATH"

          # Install Python tools for the agent session (user-level so we don't need sudo).
          python -m pip install --user \
            black \
            click \
            httpx \
            jmespath \
            json5 \
            jsonschema \
            mdformat \
            napalm \
            netmiko \
            ntc-templates \
            orjson \
            paramiko \
            pydantic \
            pylint \
            pytest \
            requests \
            rich \
            rich-click \
            ruamel.yaml \
            ruff \
            tenacity \
            textfsm \
            toml \
            tomlkit \
            tomli-w \
            tqdm \
            typer \
            yamllint

          # Install repo-lint from THIS repository (editable).
          # NOTE: This repo packages repo-lint from the repository root (pyproject.toml at repo root).
          test -f pyproject.toml || (echo "ERROR: pyproject.toml not found at repo root" >&2; exit 1)
          python -m pip install --user -e .

          # Ensure user scripts are on PATH
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Quick sanity checks (prefer python -m to avoid PATH surprises)
          rg --version
          python --version
          python -m black --version
          python -m mdformat --version
          python -m pylint --version
          python -m pytest --version
          python -m ruff --version
          python -m yamllint --version

          # repo-lint should be available both as a console script and as a module
          command -v repo-lint
          repo-lint --help
          python -m tools.repo_lint.cli --help

      # Go-based tools: shfmt + actionlint (installed only if needed)
      # Both shfmt and actionlint require Go, so we set up Go when either tool is needed
      - name: Set up Go
        if: ${{ hashFiles('**/*.sh', '.github/workflows/*.yml', '.github/workflows/*.yaml') != '' }}
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache: false

      - name: Install shfmt (when shell scripts exist)
        if: ${{ hashFiles('**/*.sh') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          go install mvdan.cc/sh/v3/cmd/shfmt@v3.9.0
          echo "$HOME/go/bin" >> "$GITHUB_PATH"
          # Note: shfmt uses --version (GNU-style), while actionlint uses -version (Go-style)
          "$HOME/go/bin/shfmt" --version

      - name: Install actionlint (when workflow files exist)
        if: ${{ hashFiles('.github/workflows/*.yml', '.github/workflows/*.yaml') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.10
          echo "$HOME/go/bin" >> "$GITHUB_PATH"
          "$HOME/go/bin/actionlint" -version

      # PowerShell tooling (installed only if .ps1 exists)
      - name: Install PSScriptAnalyzer (when PowerShell exists)
        if: ${{ hashFiles('**/*.ps1') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          pwsh -NoProfile -Command '$PSVersionTable.PSVersion'
          pwsh -NoProfile -Command "Set-PSRepository -Name PSGallery -InstallationPolicy Trusted"
          pwsh -NoProfile -Command "Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser"
          pwsh -NoProfile -Command "Import-Module PSScriptAnalyzer; Get-Module PSScriptAnalyzer | Select-Object Name,Version"

      # Perl tooling (installed only if .pl exists AND the apt packages were not installed)
      - name: Install Perl tools via cpanm (fallback)
        if: ${{ hashFiles('**/*.pl') != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # If apt packages already provided these, this is effectively a no-op.
          # cpanm is present from the OS packages step.
          cpanm --notest Perl::Critic PPI || true

          # Hard requirement: if Perl exists in-repo, perlcritic must be available
          if ! command -v perlcritic >/dev/null 2>&1; then
            echo "ERROR: perlcritic not available after install attempts" >&2
            exit 1
          fi

          # Light sanity checks (don't fail the workflow if perlcritic isn't on PATH for some reason)
          perl -v
          perlcritic --version

      # Rust toolchain + common Rust dev tools (repo contains rust/)
      - name: Set up Rust (stable + clippy + rustfmt)
        if: ${{ hashFiles('rust/**') != '' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Rust helper tools (cargo-audit, cargo-deny, cargo-llvm-cov, cargo-nextest, git-cliff, grcov, hyperfine, just, osv-scanner, taplo, trivy, typos)
        if: ${{ hashFiles('rust/**') != '' }}
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit,cargo-deny,cargo-llvm-cov,cargo-nextest,git-cliff,grcov,hyperfine,just,osv-scanner,taplo,trivy,typos

      - name: Verify Rust toolchain
        if: ${{ hashFiles('rust/**') != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # Core Rust toolchain
          rustc --version
          cargo --version
          rustfmt --version
          cargo clippy --version || true

          # Installed Rust/helper tooling (via taiki-e/install-action)
          taplo --version
          cargo audit --version
          cargo deny --version
          cargo llvm-cov --version
          cargo nextest --version

          # Extra CLI helpers
          git-cliff --version
          grcov --version
          hyperfine --version
          just --version
          osv-scanner --version
          trivy --version
          typos --version

      # Node-based Markdown linting (repo contains markdown)
      - name: Set up Node.js
        if: ${{ hashFiles('**/*.md') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install markdownlint-cli2 (when Markdown exists)
        if: ${{ hashFiles('**/*.md') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          npm install -g markdownlint-cli2@0.20.0
          # Note: markdownlint-cli2 version is verified later in the
          # "Verify key tools are available" step to keep all tool checks together.

      - name: Verify key tools are available
        shell: bash
        run: |
          set -euo pipefail
          rg --version
          jq --version
          yq --version
          zip -v | head -n 2
          unzip -v | head -n 2
          7z | head -n 2
          zstd --version
          xz --version
          pigz --version
          bzip2 --help 2>&1 | head -n 1
          lz4 -V
          pbzip2 -V
          file --version
          tree --version

          # Optional media tooling verification (commented out by default)
          # ffmpeg -version
          # mediainfo --Version

          command -v repo-lint
          repo-lint --help
          python -m tools.repo_lint.cli --help

          # Optional tools (installed only if relevant files exist)
          if git ls-files '*.sh' | rg -q .; then
            shellcheck --version
            "$HOME/go/bin/shfmt" --version
          fi

          if git ls-files '*.ps1' | rg -q .; then
            pwsh -NoProfile -Command "Import-Module PSScriptAnalyzer; Get-Command Invoke-ScriptAnalyzer | Out-Null"
          fi

          if git ls-files '*.pl' | rg -q .; then
            perlcritic --version
          fi

          if find .github/workflows -type f \( -name '*.yml' -o -name '*.yaml' \) 2>/dev/null | rg -q .; then
            "$HOME/go/bin/actionlint" -version
          fi

          if git ls-files '*.toml' | rg -q .; then
            taplo --version
          fi

          if git ls-files '*.md' | rg -q .; then
            command -v markdownlint-cli2
            # Use --no-globs to prevent config file from triggering linting during version check
            markdownlint-cli2 --version --no-globs
          fi
