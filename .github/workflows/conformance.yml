name: Multi-Language Conformance Validation

on:
  pull_request:
    paths:
      - 'RFC-Shared-Agent-Scaffolding-Example/scripts/**'
      - 'conformance/**'
      - '.github/workflows/conformance.yml'
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # This job ensures all language bundles pass their tests
  validate-all-bundles:
    name: All Bundles Conformance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate conformance vectors exist
        run: |
          if [ ! -f "conformance/vectors.json" ]; then
            echo "ERROR: conformance/vectors.json not found"
            exit 1
          fi
          echo "✅ Conformance vectors found"
          
          # Validate JSON syntax
          if ! jq empty conformance/vectors.json 2>/dev/null; then
            echo "ERROR: conformance/vectors.json is not valid JSON"
            exit 1
          fi
          echo "✅ Conformance vectors JSON is valid"
      
      - name: Check conformance README
        run: |
          if [ ! -f "conformance/README.md" ]; then
            echo "ERROR: conformance/README.md not found"
            exit 1
          fi
          echo "✅ Conformance README found"
      
      - name: Verify all language bundles exist
        run: |
          bundles=("bash" "python3" "perl" "powershell")
          missing=0
          
          for bundle in "${bundles[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/scripts/$bundle"
            if [ ! -d "$path" ]; then
              echo "ERROR: Bundle not found: $bundle"
              missing=1
            else
              echo "✅ Bundle found: $bundle"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      - name: Validate agent shard templates exist
        run: |
          shards=(
            "00_INDEX.md"
            "10_CORE_RULES.md"
            "20_GIT_WORKFLOW.md"
            "21_AUTO_MERGE_WAITING.md"
            "22_AUTOMERGE_PREFLIGHT.md"
            "30_TESTING_STANDARDS.md"
            "40_BUILD_AND_VERIFICATION.md"
            "50_DEPENDENCIES.md"
          )
          missing=0
          
          for shard in "${shards[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/.docs/agent/$shard"
            if [ ! -f "$path" ]; then
              echo "ERROR: Shard not found: $shard"
              missing=1
            else
              echo "✅ Shard found: $shard"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      - name: Validate journal templates exist
        run: |
          templates=("CURRENT.md" "TEMPLATE.md" "PR-LOG/README.md")
          missing=0
          
          for template in "${templates[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/.docs/journal/$template"
            if [ ! -f "$path" ]; then
              echo "ERROR: Journal template not found: $template"
              missing=1
            else
              echo "✅ Journal template found: $template"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      - name: Summary
        run: |
          echo "========================================="
          echo "✅ All conformance infrastructure validated"
          echo "========================================="
          echo ""
          echo "Validated:"
          echo "  - Conformance vectors (JSON schema)"
          echo "  - All 4 language bundles present"
          echo "  - Agent shard templates (8 files)"
          echo "  - Journal templates (3 files)"
          echo ""
          echo "Individual language tests run in separate jobs:"
          echo "  - test-bash.yml"
          echo "  - test-python3.yml"
          echo "  - test-perl.yml"
          echo "  - test-powershell.yml"
