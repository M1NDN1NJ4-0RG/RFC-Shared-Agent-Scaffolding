# Workflow: Multi-Language Conformance Validation
#
# Purpose: Validates that the conformance testing infrastructure is complete
# and all language bundles (bash, python3, perl, powershell) exist with their
# required structure. This workflow checks for the presence of conformance
# vectors, language bundle directories, agent shard templates, and journal
# templates, but does NOT run the actual language tests (those run separately).
#
# Triggers:
# - Pull requests that modify language bundles, conformance data, or this workflow
# - Pushes to main branch
# - Manual workflow dispatch
name: Multi-Language Conformance Validation

on:
  pull_request:
    paths:
      - 'RFC-Shared-Agent-Scaffolding-Example/scripts/**'
      - 'conformance/**'
      - '.github/workflows/conformance.yml'
  push:
    branches:
      - main
  workflow_dispatch:

# Permissions: Read-only access to repository contents
permissions:
  contents: read

jobs:
  # Job: Validate All Bundles
  # Verifies required conformance files and language bundle directories exist
  # and that conformance/vectors.json is valid JSON. Does not execute tests
  # or perform deep structure/content validation.
  validate-all-bundles:
    name: All Bundles Conformance Check
    # Runner: Ubuntu latest (sufficient for file existence checks)
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository to access conformance infrastructure
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Validate conformance/vectors.json exists and is valid JSON
      # This file defines the canonical test vectors used across all language implementations
      - name: Validate conformance vectors exist
        run: |
          if [ ! -f "conformance/vectors.json" ]; then
            echo "ERROR: conformance/vectors.json not found"
            exit 1
          fi
          echo "✅ Conformance vectors found"
          
          # Validate JSON syntax
          if ! jq empty conformance/vectors.json 2>/dev/null; then
            echo "ERROR: conformance/vectors.json is not valid JSON"
            exit 1
          fi
          echo "✅ Conformance vectors JSON is valid"
      
      # Step 3: Verify conformance/README.md exists
      # Provides documentation for the conformance testing system
      - name: Check conformance README
        run: |
          if [ ! -f "conformance/README.md" ]; then
            echo "ERROR: conformance/README.md not found"
            exit 1
          fi
          echo "✅ Conformance README found"
      
      # Step 4: Verify all 4 language bundle directories exist
      # Expected bundles: bash, python3, perl, powershell
      # Each bundle should contain scripts/, tests/, run-tests.*, and optional README_TESTS.md
      - name: Verify all language bundles exist
        run: |
          bundles=("bash" "python3" "perl" "powershell")
          missing=0
          
          for bundle in "${bundles[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/scripts/$bundle"
            if [ ! -d "$path" ]; then
              echo "ERROR: Bundle not found: $bundle"
              missing=1
            else
              echo "✅ Bundle found: $bundle"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      # Step 5: Validate agent shard template files exist
      # These 8 shard files provide modular documentation for GitHub Copilot agents
      # covering core rules, git workflow, testing standards, build verification, etc.
      - name: Validate agent shard templates exist
        run: |
          shards=(
            "00_INDEX.md"
            "10_CORE_RULES.md"
            "20_GIT_WORKFLOW.md"
            "21_AUTO_MERGE_WAITING.md"
            "22_AUTOMERGE_PREFLIGHT.md"
            "30_TESTING_STANDARDS.md"
            "40_BUILD_AND_VERIFICATION.md"
            "50_DEPENDENCIES.md"
          )
          missing=0
          
          for shard in "${shards[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/.docs/agent/$shard"
            if [ ! -f "$path" ]; then
              echo "ERROR: Shard not found: $shard"
              missing=1
            else
              echo "✅ Shard found: $shard"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      # Step 6: Validate journal template files exist
      # These 3 files provide templates for tracking work progress in .docs/journal/
      - name: Validate journal templates exist
        run: |
          templates=("CURRENT.md" "TEMPLATE.md" "PR-LOG/README.md")
          missing=0
          
          for template in "${templates[@]}"; do
            path="RFC-Shared-Agent-Scaffolding-Example/.docs/journal/$template"
            if [ ! -f "$path" ]; then
              echo "ERROR: Journal template not found: $template"
              missing=1
            else
              echo "✅ Journal template found: $template"
            fi
          done
          
          if [ $missing -eq 1 ]; then
            exit 1
          fi
      
      # Step 7: Print summary of validation results
      # Confirms all infrastructure is in place; individual language tests
      # run in separate workflow files (test-bash.yml, test-python3.yml, etc.)
      - name: Summary
        run: |
          echo "========================================="
          echo "✅ All conformance infrastructure validated"
          echo "========================================="
          echo ""
          echo "Validated:"
          echo "  - Conformance vectors (JSON schema)"
          echo "  - All 4 language bundles present"
          echo "  - Agent shard templates (8 files)"
          echo "  - Journal templates (3 files)"
          echo ""
          echo "Individual language tests run in separate jobs:"
          echo "  - test-bash.yml"
          echo "  - test-python3.yml"
          echo "  - test-perl.yml"
          echo "  - test-powershell.yml"
