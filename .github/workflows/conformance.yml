# Workflow: Multi-Language Conformance Validation
#
# Purpose: Validates that the conformance testing infrastructure is complete
# and all language bundles (bash, python3, perl, powershell) exist with their
# required structure. This workflow checks for the presence of conformance
# vectors, language bundle directories, agent shard templates, and journal
# templates, but does NOT run the actual language tests (those run separately).
#
# Triggers:
# - Pull requests that modify language bundles, conformance data, or this workflow
# - Pushes to main branch
# - Manual workflow dispatch
#
# Dependencies:
# - actions/checkout@v4
# - jq (for JSON validation)
# - conformance/vectors.json
# - Language bundle directories
#
# Outputs:
# - Status check: "All Bundles Conformance Check"
# - Artifacts: None
# - Side effects: Fails build if conformance structure is incomplete
#
# Notes:
# - This is a structural validation only - does NOT run tests
# - Required for merge
# - Exit 0 = structure complete, non-zero = missing files
---
name: Multi-Language Conformance Validation

on:
  pull_request:
    paths:
      - 'wrappers/scripts/**'
      - 'conformance/**'
      - '.github/workflows/conformance.yml'
  push:
    branches:
      - main
  workflow_dispatch:

# Permissions: Read-only access to repository contents
permissions:
  contents: read

jobs:
  # Job: Validate All Bundles
  # Verifies required conformance files and language bundle directories exist
  # and that conformance/vectors.json is valid JSON. Does not execute tests
  # or perform deep structure/content validation.
  validate-all-bundles:
    name: All Bundles Conformance Check
    # Runner: Ubuntu latest (sufficient for file existence checks)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository to access conformance infrastructure
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Validate conformance/vectors.json exists and is valid JSON
      # This file defines the canonical test vectors used across all language implementations
      - name: Validate conformance vectors exist
        run: |
          if [ ! -f "conformance/vectors.json" ]; then
            echo "ERROR: conformance/vectors.json not found"
            exit 1
          fi
          echo "✅ Conformance vectors found"

          # Validate JSON syntax
          if ! jq empty conformance/vectors.json 2>/dev/null; then
            echo "ERROR: conformance/vectors.json is not valid JSON"
            exit 1
          fi
          echo "✅ Conformance vectors JSON is valid"

      # Step 3: Verify conformance/README.md exists
      # Provides documentation for the conformance testing system
      - name: Check conformance README
        run: |
          if [ ! -f "conformance/README.md" ]; then
            echo "ERROR: conformance/README.md not found"
            exit 1
          fi
          echo "✅ Conformance README found"

      # Step 4: Verify all 4 language bundle directories exist
      # Expected bundles: bash, python3, perl, powershell
      # Each bundle should contain scripts/, tests/, run-tests.*, and optional README_TESTS.md
      - name: Verify all language bundles exist
        run: |
          bundles=("bash" "python3" "perl" "powershell")
          missing=0

          for bundle in "${bundles[@]}"; do
            path="wrappers/scripts/$bundle"
            if [ ! -d "$path" ]; then
              echo "ERROR: Bundle not found: $bundle"
              missing=1
            else
              echo "✅ Bundle found: $bundle"
            fi
          done

          if [ $missing -eq 1 ]; then
            exit 1
          fi

      # Note: Agent shard and journal templates were moved to docs/history/ai-agent-guidelines/
      # as part of M2 restructure. These files are now archived and no longer validated
      # as part of the wrapper conformance structure.

      # Step 5: Print summary of validation results
      # Confirms all infrastructure is in place; individual language tests
      # run in separate workflow files (test-bash.yml, test-python3.yml, etc.)
      - name: Summary
        run: |
          echo "========================================="
          echo "✅ All conformance infrastructure validated"
          echo "========================================="
          echo ""
          echo "Validated:"
          echo "  - Conformance vectors (JSON schema)"
          echo "  - All 4 language bundles present"
          echo ""
          echo "Note: Agent shard and journal templates moved to docs/history/"
          echo "as part of M2 restructure (archived, no longer in wrapper tree)"
          echo ""
          echo "Individual language tests run in separate jobs:"
          echo "  - test-bash.yml"
          echo "  - test-python3.yml"
          echo "  - test-perl.yml"
          echo "  - test-powershell.yml"
