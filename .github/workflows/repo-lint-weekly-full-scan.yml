# Workflow: Weekly Repo Lint Full Scan
#
# Purpose: Comprehensive lint and docstring validation across ALL languages
# in the repository, regardless of recent changes. This ensures no drift
# occurs between language contracts over time.
#
# Schedule: Runs weekly on Monday at 00:00 UTC
#
# Scope: Unlike the PR-triggered umbrella workflow (which validates only
# changed languages), this workflow validates EVERYTHING to catch:
# - Cross-language docstring drift
# - Linter configuration changes not caught by targeted validation
# - Repository-wide consistency issues
#
# Jobs:
# 1. Full Scan: All Languages - Runs repo-lint check --ci (no --only flag)
#
# Triggers:
# - Scheduled: Weekly on Monday at 00:00 UTC
# - Manual: workflow_dispatch for ad-hoc full scans
#
# Dependencies:
# - repo_lint Python package (tools/repo_lint/)
# - All language-specific linters
#
# Outputs:
# - Status check for full repository scan
# - Failure report if issues found
#
# Notes:
# - Complements the umbrella workflow (PR gate)
# - Does NOT run auto-fix (check-only mode)
# - All third-party actions pinned by commit SHA
---
name: Weekly Repo Lint Full Scan

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
  # Allow manual triggering for ad-hoc full scans

permissions:
  contents: read  # Read-only, no auto-commit

jobs:
  full-scan:
    name: Full Scan - All Languages
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.11'

      - name: Set up Perl
        uses: shogo82148/actions-setup-perl@9c1eca9952ccc07f9ca4a2097b63df93d9d138e9  # v1.31.3
        with:
          perl-version: '5.38'

      - name: Install Python linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black==24.10.0 ruff==0.8.4 pylint==3.3.2 yamllint==1.35.1 PyYAML>=6.0 click>=8.0 rich>=10.0 rich-click>=1.6.0

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          # Download shfmt binary
          wget -q https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_linux_amd64 -O shfmt
          # Download official checksums file for this release
          wget -q https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_checksums.txt -O shfmt_v3.12.0_checksums.txt
          # Extract expected SHA256 for the linux_amd64 binary
          EXPECTED_SHA256="$(grep 'shfmt_v3.12.0_linux_amd64' shfmt_v3.12.0_checksums.txt | cut -d' ' -f1)"
          # Verify the downloaded binary matches the expected checksum
          echo "${EXPECTED_SHA256}  shfmt" | sha256sum -c -
          # Make binary executable and install if verification succeeded
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg apt-transport-https software-properties-common
          # Import the Microsoft APT repository GPG key with explicit verification
          wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/packages.microsoft.gpg
          rm microsoft.gpg
          UBUNTU_VERSION="$(lsb_release -rs)"
          UBUNTU_CODENAME="$(lsb_release -cs)"
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/ubuntu/${UBUNTU_VERSION}/prod ${UBUNTU_CODENAME} main" | sudo tee /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -RequiredVersion 1.23.0 -Force -Scope CurrentUser

      - name: Install Perl::Critic
        run: |
          cpanm --quiet --notest Perl::Critic PPI

      - name: Run full repo lint check (all languages)
        run: |
          python -m tools.repo_lint check --ci --verbose

      - name: Upload failure report (if failed)
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: weekly-full-scan-failure-report
          path: |
            repo-lint-failure-reports/
            logs/
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Windows: Rich UI Validation (Phase 2.5 Blocker)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Validates Phase 2.5 Rich UI output works correctly on Windows.
  # Tests Rich console output, Rich-Click help, and shell completion.
  # Per Phase 2.5 spec: "Windows validation is a RELEASE BLOCKER".
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  windows-rich-ui-validation:
    name: "Windows: Rich UI Validation"
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Install repo-lint dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML>=6.0 click>=8.0 rich>=10.0 rich-click>=1.6.0

      - name: Test Rich Console Output (CI Mode)
        id: test_ci_mode
        run: |
          Write-Host "━━━━ Testing Rich UI in CI Mode ━━━━"
          python -m tools.repo_lint check --ci --only python
          if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1 -or $LASTEXITCODE -eq 2) {
            Write-Host "✓ CI mode output produced successfully (exit code: $LASTEXITCODE)"
            exit 0
          } else {
            Write-Host "✗ Unexpected exit code: $LASTEXITCODE"
            exit 1
          }
        shell: pwsh

      - name: Test Rich Console Output (Interactive Mode)
        id: test_interactive_mode
        run: |
          Write-Host "━━━━ Testing Rich UI in Interactive Mode ━━━━"
          # Force interactive mode by not using --ci
          python -m tools.repo_lint check --only python
          if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1 -or $LASTEXITCODE -eq 2) {
            Write-Host "✓ Interactive mode output produced successfully (exit code: $LASTEXITCODE)"
            exit 0
          } else {
            Write-Host "✗ Unexpected exit code: $LASTEXITCODE"
            exit 1
          }
        shell: pwsh

      - name: Test Rich-Click Help Output
        id: test_help
        run: |
          Write-Host "━━━━ Testing Rich-Click Help Output ━━━━"
          # Test main help
          python -m tools.repo_lint --help > help_main.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "✗ Main help failed"
            exit 1
          }
          # Test check command help
          python -m tools.repo_lint check --help > help_check.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "✗ Check help failed"
            exit 1
          }
          # Test fix command help
          python -m tools.repo_lint fix --help > help_fix.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "✗ Fix help failed"
            exit 1
          }
          # Test install command help
          python -m tools.repo_lint install --help > help_install.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "✗ Install help failed"
            exit 1
          }
          Write-Host "✓ All help commands succeeded"
          # Verify help contains Rich formatting
          $main_help = Get-Content help_main.txt -Raw
          if ($main_help -match "check|fix|install") {
            Write-Host "✓ Help output contains expected commands"
          } else {
            Write-Host "✗ Help output missing expected commands"
            exit 1
          }
        shell: pwsh

      - name: Test PowerShell Completion (Shell Integration)
        id: test_completion
        run: |
          Write-Host "━━━━ Testing PowerShell Completion ━━━━"
          # Test that completion can be generated (basic sanity check)
          # Note: Full shell completion testing requires interactive shell
          $env:_REPO_LINT_COMPLETE = "powershell_complete"
          python -m tools.repo_lint > completion_test.txt 2>&1; $true
          # Just verify the command doesn't crash - actual completion requires interactive shell
          Write-Host "✓ Completion generation didn't crash"
        shell: pwsh

      - name: Upload Windows Validation Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: windows-validation-results-weekly
          path: |
            help_*.txt
            completion_test.txt
          retention-days: 30
